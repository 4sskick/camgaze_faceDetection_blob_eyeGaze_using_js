
<html>
    <head>
        <script text="text/javascript" src="/camgaze.js/js/jsfeat.js"></script>
        <script text="text/javascript" src="/camgaze.js/js/compatibility.js"></script>
        <script text="text/javascript" src="/camgaze.js/js/camgaze.js"></script>
        <script text="text/javascript" src="/camgaze.js/cascades/eye.js"></script>
        <script type="text/javascript" src="http://codeorigin.jquery.com/jquery-2.0.3.min.js"></script>
    </head>
    <body>
    	<button id="startButton" onclick="startButtonClicked()">Start</button>
        <canvas id="mainCanvas"></canvas>
        <video style="display:none;" autoplay></video>
        <script text="text/javascript">
			function startButtonClicked() {

				$("#startButton").remove();
				//alert("balls");
				// width and height of the canvas
				var height = document.height;
				var width = document.width;

				var cGaze = new camgaze.Camgaze(
					width, 
					height, 
					"mainCanvas",
					true
				);

				// height and width here refer to the video width and height
				var eyeTracker = new camgaze.EyeTracker(640, 480);
				var eyeFilter = new camgaze.EyeFilter();

				var canvas = document.getElementById('mainCanvas');

				var drawer = new camgaze.drawing.CanvasDrawer(
					"mainCanvas",
					document.width,
					document.height
				);
				var clickCounter = 0;
				var calibrationPoints = [
					new camgaze.structures.Point(
						33, 
						40
					),
					new camgaze.structures.Point(
						document.width - 50, 
						40
					),
					new camgaze.structures.Point(
						33, 
						document.height - 70
					),
					new camgaze.structures.Point(
						document.width - 50, 
						document.height - 70
					)
				];

				canvas.addEventListener("click", function (e) {
					if (clickCounter < 3) {
						clickCounter++;
					}
				});

				var frameOp = function (image_data, video, canvasDrawer) {
					canvasDrawer.clearAll()
					canvasDrawer.clearCanvas()
					var trackingData = eyeTracker.track(image_data, video);
					var gazeList = eyeFilter.getFilteredGaze(trackingData);
					
					var avgLookingPoint = eyeFilter.getAverageLookingPoint(
						trackingData
					);

					canvasDrawer.drawCircle(
						new camgaze.structures.Point(
							parseInt((document.width / 2).toFixed(0)) + avgLookingPoint.x,
							parseInt((document.height / 2).toFixed(0)) + avgLookingPoint.y
						),
						10,
						-1,
						"blue"
					);

					canvasDrawer.drawCircle(
						calibrationPoints[clickCounter],
						30,  // radius
						-1, // line width (filled)
						"green"
					)

					if (trackingData.eyeList.length > 0) {
						gazeList.forEach(
							function (eye) {
								canvasDrawer.drawCircle(
									eye.centroid.unfiltered,
									5,  // radius
									-1, // line width (filled)
									"red"
								);
							}
						);
					}
					canvasDrawer.drawAll(false);
				};
				cGaze.setFrameOperator(frameOp);
			} 
		</script>
</html>

